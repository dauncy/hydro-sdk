{"version":3,"sources":["../../src/rules/checkTypes.js"],"names":["strictNativeTypes","jsdocNode","sourceCode","report","utils","context","jsdocTags","filterTags","tag","isTagWithType","preferredTypes","_","get","optionObj","options","noDefaults","unifyParentAndChildTypeChecks","forEach","jsdocTag","invalidTypes","typeAst","type","error","getPreferredTypeInfo","nodeName","parentName","parentNode","hasMatchingPreferredType","isGenericMatch","typeName","parentType","syntax","some","checkPostFix","syn","undefined","directNameMatch","unifiedSyntaxParentMatch","adjustNames","preferred","node","ret","meta","dotBracketEnd","match","slice","length","bracketEnd","endsWith","name","replace","includes","preferredSetting","push","strictNativeType","toLowerCase","fixedType","tagName","badType","preferredType","message","fix","fixer","replaceText","getText","tagValue","replacement","iterateAllJsdocs","fixable","schema","additionalProperties","properties"],"mappings":"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","sourcesContent":["import _ from 'lodash';\nimport {parse, traverse, publish} from 'jsdoctypeparser';\nimport iterateJsdoc from '../iterateJsdoc';\n\nconst strictNativeTypes = [\n  'undefined',\n  'null',\n  'boolean',\n  'number',\n  'string',\n  'object',\n  'Array',\n  'Function',\n  'Date',\n  'RegExp'\n];\n\nexport default iterateJsdoc(({\n  jsdocNode,\n  sourceCode,\n  report,\n  utils,\n  context\n}) => {\n  const jsdocTags = utils.filterTags((tag) => {\n    return utils.isTagWithType(tag.tag);\n  });\n\n  const preferredTypes = _.get(context, 'settings.jsdoc.preferredTypes');\n  const optionObj = context.options[0];\n  const noDefaults = _.get(optionObj, 'noDefaults');\n  const unifyParentAndChildTypeChecks = _.get(optionObj, 'unifyParentAndChildTypeChecks');\n\n  jsdocTags.forEach((jsdocTag) => {\n    const invalidTypes = [];\n    let typeAst;\n\n    try {\n      typeAst = parse(jsdocTag.type);\n    } catch (error) {\n      return;\n    }\n\n    const getPreferredTypeInfo = (type, nodeName, parentName, parentNode) => {\n      let hasMatchingPreferredType;\n      let isGenericMatch;\n      let typeName = nodeName;\n      if (preferredTypes) {\n        const parentType = parentName === 'subject';\n        if (unifyParentAndChildTypeChecks || parentType) {\n          const syntax = _.get(parentNode, 'meta.syntax');\n\n          [\n            ['.', 'ANGLE_BRACKET_WITH_DOT'],\n            ['.<>', 'ANGLE_BRACKET_WITH_DOT'],\n            ['<>', 'ANGLE_BRACKET']\n          ].some(([checkPostFix, syn]) => {\n            isGenericMatch = _.get(\n              preferredTypes,\n              nodeName + checkPostFix\n            ) !== undefined &&\n              syntax === syn;\n            if (isGenericMatch) {\n              typeName += checkPostFix;\n            }\n\n            return isGenericMatch;\n          });\n          if (!isGenericMatch && parentType) {\n            [\n              ['[]', 'SQUARE_BRACKET'],\n              ['.', 'ANGLE_BRACKET_WITH_DOT'],\n              ['.<>', 'ANGLE_BRACKET_WITH_DOT'],\n              ['<>', 'ANGLE_BRACKET']\n            ].some(([checkPostFix, syn]) => {\n              isGenericMatch = _.get(preferredTypes, checkPostFix) !== undefined &&\n                syntax === syn;\n              if (isGenericMatch) {\n                typeName = checkPostFix;\n              }\n\n              return isGenericMatch;\n            });\n          }\n        }\n        const directNameMatch = _.get(preferredTypes, nodeName) !== undefined;\n        const unifiedSyntaxParentMatch = parentType && directNameMatch && unifyParentAndChildTypeChecks;\n        isGenericMatch = isGenericMatch || unifiedSyntaxParentMatch;\n\n        hasMatchingPreferredType = isGenericMatch ||\n          directNameMatch && !parentType;\n      }\n\n      return [hasMatchingPreferredType, typeName, isGenericMatch];\n    };\n\n    const adjustNames = (type, preferred, isGenericMatch, nodeName, node, parentNode) => {\n      let ret = preferred;\n      if (isGenericMatch) {\n        if (preferred === '[]') {\n          parentNode.meta.syntax = 'SQUARE_BRACKET';\n          ret = 'Array';\n        } else {\n          const dotBracketEnd = preferred.match(/\\.(?:<>)?$/);\n          if (dotBracketEnd) {\n            parentNode.meta.syntax = 'ANGLE_BRACKET_WITH_DOT';\n            ret = preferred.slice(0, -dotBracketEnd[0].length);\n          } else {\n            const bracketEnd = preferred.endsWith('<>');\n            if (bracketEnd) {\n              parentNode.meta.syntax = 'ANGLE_BRACKET';\n              ret = preferred.slice(0, -2);\n            }\n          }\n        }\n      } else if (type === 'ANY') {\n        node.type = 'NAME';\n      }\n      node.name = ret.replace(/(?:\\.|<>|\\.<>|\\[])$/, '');\n\n      // For bare pseudo-types like `<>`\n      if (!ret) {\n        node.name = nodeName;\n      }\n\n      return ret;\n    };\n\n    traverse(typeAst, (node, parentName, parentNode) => {\n      const {type, name} = node;\n      if (!['NAME', 'ANY'].includes(type)) {\n        return;\n      }\n      let nodeName = type === 'ANY' ? '*' : name;\n\n      const [hasMatchingPreferredType, typeName, isGenericMatch] = getPreferredTypeInfo(type, nodeName, parentName, parentNode);\n\n      let preferred;\n      if (hasMatchingPreferredType) {\n        const preferredSetting = preferredTypes[typeName];\n        nodeName = typeName === '[]' ? typeName : nodeName;\n\n        if (!preferredSetting) {\n          invalidTypes.push([nodeName]);\n        } else if (typeof preferredSetting === 'string') {\n          preferred = preferredSetting;\n          invalidTypes.push([nodeName, preferred]);\n        } else if (typeof preferredSetting === 'object') {\n          preferred = _.get(preferredSetting, 'replacement');\n          invalidTypes.push([\n            nodeName,\n            preferred,\n            _.get(preferredSetting, 'message')\n          ]);\n        } else {\n          report(\n            'Invalid `settings.jsdoc.preferredTypes`. Values must be falsy, a string, or an object.',\n            null,\n            jsdocTag\n          );\n\n          return;\n        }\n      } else if (!noDefaults && type === 'NAME') {\n        for (const strictNativeType of strictNativeTypes) {\n          if (strictNativeType.toLowerCase() === nodeName.toLowerCase() &&\n            strictNativeType !== nodeName &&\n\n            // Don't report if user has own map for a strict native type\n            (!preferredTypes || _.get(preferredTypes, strictNativeType) === undefined)\n          ) {\n            preferred = strictNativeType;\n            invalidTypes.push([nodeName, preferred]);\n            break;\n          }\n        }\n      }\n\n      // For fixer\n      if (preferred) {\n        preferred = adjustNames(type, preferred, isGenericMatch, nodeName, node, parentNode);\n      }\n    });\n\n    if (invalidTypes.length) {\n      const fixedType = publish(typeAst);\n\n      const tagName = jsdocTag.tag;\n      invalidTypes.forEach(([badType, preferredType = '', message]) => {\n        const fix = (fixer) => {\n          return fixer.replaceText(\n            jsdocNode,\n            sourceCode.getText(jsdocNode).replace(\n              '{' + jsdocTag.type + '}', '{' + fixedType + '}'\n            )\n          );\n        };\n\n        const tagValue = jsdocTag.name ? ' \"' + jsdocTag.name + '\"' : '';\n\n        report(\n          message ||\n            'Invalid JSDoc @' + tagName + tagValue + ' type \"' + badType +\n              (preferredType ? '\"; prefer: \"' + preferredType : '') +\n              '\".',\n          preferredType ? fix : null,\n          jsdocTag,\n          message ? {\n            badType,\n            preferredType,\n            replacement: preferredType,\n            tagName,\n            tagValue\n          } : null\n        );\n      });\n    }\n  });\n}, {\n  iterateAllJsdocs: true,\n  meta: {\n    fixable: 'code',\n    schema: [\n      {\n        additionalProperties: false,\n        properties: {\n          noDefaults: {\n            type: 'boolean'\n          },\n          unifyParentAndChildTypeChecks: {\n            type: 'boolean'\n          }\n        },\n        type: 'object'\n      }\n    ],\n    type: 'suggestion'\n  }\n});\n"],"file":"checkTypes.js"}